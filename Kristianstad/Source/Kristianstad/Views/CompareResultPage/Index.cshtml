@using Kristianstad.Models.Pages.Compare
@using Kristianstad.ViewModels.Compare
@using EPiServer.Editor
@using EPiServer.Security
@using EPiServer.Web.Mvc.Html
@using Kristianstad.Business.Models.Blocks.Compare
@using Kristianstad.CompareDomain.Models

@model Kristianstad.ViewModels.Compare.CompareResultPageModel

@Html.CssLink("~/Content/compare.css")

<script>
    function GetSearchLocation(adress)
    {
        var geocoder = new google.maps.Geocoder();
        geocoder.geocode({ 'address': adress }, function (results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
                document.getElementById("MeasureFromAddress").innerHTML = results[0].formatted_address;
            }
        });
    }

    function GetLocation(addressValue1, addressValue2, fn) {
             var geocoder= new google.maps.Geocoder();
             var address1 = addressValue1;
             var address2 = addressValue2;
             geocoder.geocode({ 'address': address1 }, function (results, status) {
                 if (status == google.maps.GeocoderStatus.OK) {
                     var latitude1 = results[0].geometry.location.lat();
                     var longitude1 = results[0].geometry.location.lng();
                     var string = latitude1 + "," + longitude1;

                     geocoder.geocode({ 'address': address2 }, function (results, status) {
                         if (status == google.maps.GeocoderStatus.OK) {
                             var latitude2 = results[0].geometry.location.lat();
                             var longitude2 = results[0].geometry.location.lng();
                             var string2 = string + "," + latitude2 + "," + longitude2;
                             fn(string2);
                         }
                     });
                 } else {
                     return ("Request failed.");
                 }
             });
    };

    function getDistanceFromLatLonInKm(latlon) {
        var res = latlon.split(",");
        var R = 6371; // Radius of the earth in km
        var dLat = deg2rad(res[2]-res[0]);  // deg2rad below
        var dLon = deg2rad(res[3]-res[1]);
        var a =
          Math.sin(dLat/2) * Math.sin(dLat/2) +
          Math.cos(deg2rad(res[0])) * Math.cos(deg2rad(res[2])) *
          Math.sin(dLon/2) * Math.sin(dLon/2)
        ;
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        var d = R * c; // Distance in km
        var distans = Math.round(d * 100) / 100;
        return distans;
    }

    function deg2rad(deg) {
        return deg * (Math.PI/180)
    }
</script>

<div class="column small-12 medium-12 large-12 content-page content">
    @{
        Html.RenderAction("Breadcrumbs", "MenuKr");
    }
    
    <h1 @Html.EditAttributes(x => x.CurrentPage.PageName)>@Model.CurrentPage.PageName</h1>

    @Html.PropertyFor(x => x.CurrentPage.Description)

    @using (Html.BeginForm("Index", "CompareResultPage"))
    {
        <div class="row">
            <div class="column small-12 medium-12 large-10">
                @Html.TextBox("address")
            </div>
            <div class="column small-12 medium-12 large-2">
                <input type="submit" class="button" value="Skriv in address" />
            </div>
        </div>
        <hr />
    }

    @if (@Model.DistanceList.MeasureFromAddress != null)
    {
        <div>Adress för distansmätning: 
        <span id="MeasureFromAddress">
            Ingen funnen adress.
        </span>
        <script>
            GetSearchLocation(@Html.Raw(Json.Encode(Model.DistanceList.MeasureFromAddress)));
        </script>
        </div><hr />
    }


    <div class="compare-main-box">
        <table class="compare-table">
            <thead>
                <tr>
                    <td></td>
                    @foreach (OrganisationalUnitModel ou in Model.OrganisationalUnits)
                    {
                        <td>
                            <div>
                                <p>@ou.Title</p>
                            </div>
                            <div>
                                @if (ou.TitleImage != null)
                                {
                                    <img src="@Url.ContentUrl(ou.TitleImage)" />
                                }
                                else
                                {
                                    <img src="~/Content/img/template/img-innehallssida.jpg" />
                                }
                            </div>
                        </td>
                    }
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="query"><div><span>Address</span></div></td>
                    @foreach (OrganisationalUnitModel ou in Model.OrganisationalUnits)
                    {
                        <td class="result">
                            @if (ou.Adress != null)
                            {
                                <div><span>@ou.Adress</span></div>
                            }
                            else
                            {
                                <div><span class="noValue">Inget värde.</span></div>
                            }
                        </td>
                    }
                </tr>

                <tr>
                    <td class="query"><div><span>Telefon</span></div></td>
                    @foreach (OrganisationalUnitModel ou in Model.OrganisationalUnits)
                    {
                        <td class="result">
                            @if (ou.Telephone != null)
                            {
                                <div><span>@ou.Telephone</span></div>
                            }
                            else
                            {
                                <div><span class="noValue">Inget värde.</span></div>
                            }
                        </td>
                    }
                </tr>

                <tr>
                    <td class="query"><div><span>E-mail</span></div></td>
                    @foreach (OrganisationalUnitModel ou in Model.OrganisationalUnits)
                    {
                        <td class="result">
                            @if (ou.Email != null)
                            {
                                <div><a href="mailto:@ou.Email">@ou.Email</a></div>
                            }
                            else
                            {
                                <div><span class="noValue">Inget värde.</span></div>
                            }
                        </td>
                    }
                </tr>

                @if (Model.DistanceList.MeasureFromAddress != null)
                {
                    <tr>
                        <td class="query"><div><span>Distans</span></div></td>
                        @foreach (OrganisationalUnitModel ou in Model.OrganisationalUnits)
                        {
                            <td id="@ou.Adress" class="result">
                                <span>
                                    -
                                    <script>
                                        GetLocation(@Html.Raw(Json.Encode(ou.Adress)), @Html.Raw(Json.Encode(Model.DistanceList.MeasureFromAddress)), function(result){ document.getElementById(@Html.Raw(Json.Encode(ou.Adress))).innerHTML = getDistanceFromLatLonInKm(result) + " km"; });
                                    </script>
                                </span>
                            </td>
                        }
                    </tr>

                }

                @foreach (PropertyQueryWithResults pqwr in (List<PropertyQueryWithResults>)ViewData["existingQueries"])
                {
                    <tr>
                        <td class="query"><div><span>@pqwr.Query.Name</span></div></td>
                        
                        @foreach (OrganisationalUnitModel ou in Model.OrganisationalUnits)
                        {
                            float? viewValue = null;
                            int? viewPeriod = null;

                            <td class="result">
                                @if (@pqwr.Results.Where(x => x.OrganisationalUnitId == ou.SourceId).First().PeriodValues.Count > 0)
                                {
                                    pqwr.Results.Where(x => x.OrganisationalUnitId == ou.SourceId).Reverse();

                                    foreach (PropertyQueryResult periods in @pqwr.Results.Where(x => x.OrganisationalUnitId == ou.SourceId))
                                    {
                                        foreach (PropertyQueryResultForPeriod valuePeriod in periods.PeriodValues)
                                        {
                                            foreach (PropertyQueryResultValue value in valuePeriod.Values)
                                            {
                                                if (value.Value != null)
                                                {
                                                    viewValue = value.Value;
                                                }

                                                if (viewValue != null)
                                                {
                                                    break;
                                                }
                                            }

                                            if (viewValue != null)
                                            {
                                                viewPeriod = valuePeriod.Period;
                                                break;
                                            }
                                        }

                                        if (viewValue != null)
                                        {
                                            break;
                                        }
                                    }

                                    if (viewValue != null)
                                    {
                                        if (pqwr.Query.Name.Contains('%'))
                                        {
                                            <div class="answer-percent-bar">
                                                <div class="percentageBox">
                                                    <div class="percentage" style="width: @((int)viewValue)%"></div>
                                                </div>
                                                <div class="percentageValue">
                                                    <span title="År: @viewPeriod">
                                                        @viewValue%
                                                    </span>
                                                </div>
                                            </div>
                                        }
                                        else
                                        {
                                            <div>
                                                <span title="År: @viewPeriod">
                                                    @viewValue
                                                </span>
                                            </div>
                                        }
                                    }
                                }
                                else
                                {
                                    <div>
                                        <span title="Inget värde." class="noValue">
                                            -
                                        </span>
                                    </div>
                                }
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @if (PageEditing.PageIsInEditMode)
    {
        <div class="row editor-only-element">

            <h3>Lägg till/ta bort frågor till jämförelsen</h3>

            <div class="span8 clearfix">

                @Html.Partial("_AddPropertyQueriesForm")

            </div>

                        
        </div>
    }

</div>

